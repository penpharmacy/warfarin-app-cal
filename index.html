<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>เครื่องคำนวณการให้ยา Warfarin ห้องยาโรงพยาบาลพุนพิน</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<style>
/* --- COPY PROTECTION STYLES (เดิม) --- */
body {
    user-select: none; /* Standard syntax */
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none; /* Firefox */
    -ms-user-select: none; /* IE/Edge */
    background:linear-gradient(180deg,var(--bg),#FFFFFF);
    margin:0;
    padding:20px;
    color:#263238;
}
/* ------------------------------- */

:root{
    --bg:#F0F8FF; 
    --card:#FFFFFF;
    --accent:#00A896;
    --accent-light:#CCEEEA;
    --muted:#5A6A70;
    --highlight:#75C2B9;

    --plan-bg-1: #F8FFFF;
    --plan-bg-2: #FFFBF8;
    --plan-bg-3: #FAF8FF;
    --plan-border-1: #40B2D6;
    --plan-border-2: #FFAD60;
    --plan-border-3: #AA8CFF;

    --main-pink: #E91E63;
    --light-pink: #FDE8F1;
    --accent-green: #4CAF50;
    font-family: 'Kanit', sans-serif;
}
body::before{
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* สมมุติว่าคุณมี logo1.gif ใน path ที่ถูกต้อง */
    background: url('logo1.gif') center center no-repeat; 
    background-size: 380px auto;
    opacity: 0.06;
    z-index: -1;
}
header{display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:20px;text-align:center;flex:1;color:var(--accent)}
.container{max-width:980px;margin:20px auto}
.card{background:var(--card);border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,0.08);padding:18px;margin-bottom:16px;border-top:4px solid var(--highlight)}
label{display:block;font-size:14px;margin-bottom:6px;color:var(--muted)}
input[type=number]{width:100%;padding:10px;border-radius:10px;border:1px solid #cfd8dc;font-size:16px;background:#FAFAFA;}
.row{display:flex;gap:12px}
.col{flex:1}
.radio-row{display:flex;gap:10px;flex-wrap:wrap}
.pill{padding:8px 14px;border-radius:20px;border:1px solid #B2DFDB;background:#E0F2F1;cursor:pointer;transition:all 0.2s ease}
.pill:hover{background:var(--highlight);color:#004D40}
button.primary{background:var(--accent);color:#fff;border:0;padding:12px 20px;border-radius:12px;font-weight:600;cursor:pointer;transition:all 0.2s ease}
button.primary:hover{background:#008F85}
.result{margin-top:12px}
table{width:100%;border-collapse:collapse;border-radius:10px;overflow:hidden; table-layout: fixed; }
th,td{padding:8px;border-bottom:1px solid #E0F2F1;text-align:center; font-size: 14px;}
th{background:var(--accent-light);color:#004D40}
.plan-table tbody tr:nth-child(odd) { background-color: #F8F8F8; }
.plan-table.plan-1 tbody tr:nth-child(odd) { background-color: #F9FFFF; }
.plan-table.plan-2 tbody tr:nth-child(odd) { background-color: #FFFFF9; }
.plan-table.plan-3 tbody tr:nth-child(odd) { background-color: #FCFAFF; }
.small{font-size:13px;color:var(--muted)}
.note{background:var(--accent-light);padding:10px;border-radius:10px;margin-top:8px;white-space:pre-line;color:#004D40}
footer{font-size:13px;color:var(--muted);text-align:center;padding:8px}
@media(max-width:720px){.row{flex-direction:column}}
.plan-section { padding: 15px; margin-top: 15px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow-x: auto;}
.plan-section.plan-1 { background-color: var(--plan-bg-1); border-left: 5px solid var(--plan-border-1);}
.plan-section.plan-2 { background-color: var(--plan-bg-2); border-left: 5px solid var(--plan-border-2);}
.plan-section.plan-3 { background-color: var(--plan-bg-3); border-left: 5px solid var(--plan-border-3);}
.plan-table { min-width: 700px; }
.plan-grid { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px; }
.day-card { min-width: 120px; flex-grow: 1; text-align: center; padding: 10px 5px; border-radius: 12px; border: 1px solid #E0E0E0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); background-color: #FFFFFF; }
.day-name { font-weight: 600; padding: 2px 0; margin-bottom: 4px; border-radius: 8px; color: #333; }
.day-name.mon { background-color: #FFECC6; border: 1px solid #FFC107; color: #333; }
.day-name.tue { background-color: #E6E1F4; border: 1px solid #673AB7; color: #333; }
.day-name.wed { background-color: #E6F7E6; border: 1px solid #4CAF50; color: #333; }
.day-name.thu { background-color: #FEEED7; border: 1px solid #FF9800; color: #333; }
.day-name.fri { background-color: #E1F1FD; border: 1px solid #2196F3; color: #333; }
.day-name.sat { background-color: #FDE8F1; border: 1px solid #E91E63; color: #333; }
.day-name.sun { background-color: #FCE6E6; border: 1px solid #F44336; color: #333; }
.daily-mg { font-size: 14px; color: #4CAF50; font-weight: 500; margin-bottom: 6px; }
.daily-dose-text { font-size: 12px; color: var(--muted); line-height: 1.4; margin-top: 4px; }
.pill-container { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; align-items: center; padding: 4px 0; min-height: 32px; }
.pill-icon-wrapper { position: relative; display: inline-block; flex-shrink: 1; --pill-size: 24px; }
.pill-icon { width: var(--pill-size); height: var(--pill-size); border-radius: 50%; display: inline-block; cursor: default; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s ease; }
.pill-icon-3mg { background-color: #4FC3F7; } /* สีฟ้า */
.pill-icon-2mg { background-color: #FFB74D; } /* สีส้ม */
.pill-icon-5mg { background-color: var(--main-pink); } /* สีชมพู (ใหม่) */
.half-pill { width: var(--pill-size); height: var(--pill-size); border-radius: 50%; clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%); }
.pill-container.shrink-pills .pill-icon-wrapper { --pill-size: 18px; gap: 2px; }
.pill-container.shrink-pills .pill-icon-wrapper .tooltip-text { font-size: 10px; }
.pill-icon-wrapper .tooltip-text { visibility: hidden; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 5px 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; transform: translateX(-50%); white-space: nowrap; opacity: 0; transition: opacity 0.2s; font-size: 12px; }
.pill-icon-wrapper:hover .tooltip-text { visibility: visible; opacity: 1; }
.pill-icon-wrapper .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
.summary-pill { display: inline-block; width: 14px; height: 14px; border-radius: 50%; margin-right: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.summary-line { font-size: 14px; margin-top: 5px; }

/* --- สไตล์สำหรับส่วนคำนวณ Warfarin แบบคูณวัน (ใหม่) --- */
.standalone-calculator {
    max-width: 980px;
    margin: 20px auto 0;
    padding: 18px;
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
    border-top: 4px solid var(--main-pink); 
}

.calculator-header-new {
    font-size: 20px;
    font-weight: 600;
    color: var(--main-pink);
    padding-bottom: 10px;
    border-bottom: 2px solid var(--light-pink);
    margin-bottom: 15px;
    text-align: center;
}

/* ภาชนะหลักที่ใช้ Flexbox ในการจัดวาง 2mg, 3mg, 5mg และ Comparison */
.dosing-comparison-container {
    display: flex;
    gap: 12px;
}

/* ภาชนะย่อยสำหรับ Warfarin 2mg, 3mg, 5mg (ให้แบ่งพื้นที่เท่าๆ กัน) */
.pill-dosing-container {
    display: flex;
    flex-direction: column; /* จัดองค์ประกอบในแนวตั้งภายในกรอบ */
    flex: 1 1 20%; /* ปรับให้ 4 คอลัมน์เท่ากัน โดยมีพื้นที่หลักมากกว่า (20% * 4 = 80%) */
}

.dose-input-group {
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 8px;
    flex-grow: 1; /* ให้กรอบยืดเต็มความสูงของ column */
}

/* 🌟 สไตล์ Warfarin 2 mg (โทนส้ม) */
#dose2mgContainer {
    background: #FFFBF8; /* ขาวอมส้ม */
    border: 1px solid #FFAD60;
}
#dose2mgContainer .pill-section-title {
    color: #FFAD60;
    border-bottom: 1px dashed #FFDDAA;
}

/* 🌟 สไตล์ Warfarin 3 mg (โทนฟ้า) */
#dose3mgContainer {
    background: #F8FFFF; /* ขาวอมฟ้า */
    border: 1px solid #40B2D6;
}
#dose3mgContainer .pill-section-title {
    color: #40B2D6;
    border-bottom: 1px dashed #A0D0E0;
}

/* 🌟 สไตล์ Warfarin 5 mg (โทนชมพู/แดง) - ใหม่ */
#dose5mgContainer {
    background: var(--light-pink); /* สีพื้นหลังชมพูอ่อน */
    border: 1px solid var(--main-pink); /* ขอบสีชมพูเข้ม */
}
#dose5mgContainer .pill-section-title {
    color: var(--main-pink); /* ตัวอักษรสีชมพูเข้ม */
    border-bottom: 1px dashed #FFCCD5; /* เส้นใต้สีชมพูอ่อน */
}


.dose-input-row {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 8px;
    font-size: 13px; /* ทำให้กะทัดรัดขึ้น */
}

.dose-input-row label {
    flex-basis: auto;
    font-size: 13px;
    color: #333;
    margin: 0;
    display: block;
    white-space: nowrap;
}

.dose-input-row input[type="number"] {
    width: 45px; /* ลดขนาดช่องป้อนตัวเลข */
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-align: center;
    font-size: 13px;
    box-sizing: border-box;
    height: 30px;
}

.pill-section-title {
    font-weight: 600;
    margin-bottom: 5px;
    padding-bottom: 5px;
    text-align: center; /* จัดให้อยู่ตรงกลางของกรอบเล็ก */
}

.add-row-btn {
    background: var(--light-pink);
    color: var(--main-pink);
    border: 1px solid var(--main-pink);
    padding: 6px 10px;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
    margin-top: 5px;
    font-size: 12px;
    width: 100%; /* ให้ปุ่มกว้างเต็มกรอบ */
}
.add-row-btn:hover { background: #FFDDEE; }

/* 🌟 ส่วนเปรียบเทียบและการจ่ายยา (โทนขาว) */
.comparison-section {
    flex: 1 1 30%; /* ปรับพื้นที่ให้เยอะกว่าเล็กน้อย */
    padding: 15px;
    border-radius: 8px;
    background: #FFFFFF; /* สีพื้นหลังขาว */
    border: 1px solid #cfd8dc; /* ขอบเทาอ่อน */
}

.comparison-section h4 {
    margin-top: 0;
    color: #40B2D6;
    border-bottom: 1px dashed #A0D0E0;
    padding-bottom: 5px;
}

.comparison-output {
    margin-top: 15px;
    padding: 15px;
    border: 1px solid #cfd8dc;
    border-left: 5px solid var(--accent-green); 
    border-radius: 8px; 
    background: #F0FFF0;
}

.comparison-output p {
    margin: 5px 0;
    font-size: 16px;
    line-height: 1.5;
}

.comparison-output strong {
    color: var(--accent-green);
    font-weight: 700;
    font-size: 17px;
}

.action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: flex-end;
}

.action-buttons button {
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: background 0.2s;
}

.calculate-btn {
    background: var(--main-pink);
    color: white;
}
.calculate-btn:hover { background: #C2185B; }

.clear-btn {
    background: #ccc;
    color: #333;
}
.clear-btn:hover { background: #B0B0B0; }

@media(max-width:900px){
    /* บนหน้าจอเล็ก จัดเรียงเป็นแนวตั้ง */
    .dosing-comparison-container {
        flex-direction: column;
    }
    .pill-dosing-container {
        flex: 1 1 100%;
        gap: 12px;
    }
    .comparison-section {
        flex: 1 1 100%;
    }
    .dose-input-row {
        flex-wrap: wrap; 
        justify-content: space-between;
    }
    .dose-input-row label {
        width: auto;
    }
    .dose-input-row input[type="number"] {
        width: 60px;
    }
}
</style>
</head>
<body oncontextmenu="return false;">
<div class="container">
    
    <header class="card" style="align-items:center">
        <h1>เครื่องคำนวณการให้ยา Warfarin โรงพยาบาลพุนพิน</h1>
    </header>
    <section class="card">
        <form id="form">
            <div class="row">
                <div class="col">
                    <label>INR ปัจจุบัน</label>
                    <input type="number" step="0.01" id="inr" min="0" value="2.5" required>
                </div>
                <div class="col">
                    <label>ขนาดยา Warfarin ต่อสัปดาห์ (mg)</label>
                    <input type="number" step="0.1" id="weeklyDose" min="0" required>
                </div>
                <div class="col">
                    <label>จำนวนวันนัด (วัน)</label>
                    <input type="number" id="days" min="1" value="7" required>
                </div>
            </div>
            <div style="margin-top:12px">
                <label>ชนิดเม็ดยาที่ใช้</label>
                <div class="radio-row">
                    <label class="pill"><input type="radio" name="pills" value="3" checked> ใช้เม็ด 3 mg เท่านั้น</label>
                    <label class="pill"><input type="radio" name="pills" value="2"> ใช้เม็ด 2 mg เท่านั้น</label>
                    <label class="pill"><input type="radio" name="pills" value="both"> ใช้ทั้ง 2 และ 3 mg</label>
                    <label class="pill"><input type="radio" name="pills" value="3mg_fixed_1dayoff"> 3 mgไม่มีแบ่งครึ่ง แต่อาจมีวันหยุดได้</label>
                    <label class="pill"><input type="radio" name="pills" value="2mg_fixed_1dayoff"> 2 mgไม่มีแบ่งครึ่ง แต่อาจมีวันหยุดได้</label>
                </div>
            </div>
            <div style="margin-top:12px" class="row">
                <div class="col">
                    <label>ภาวะเลือดออก</label>
                    <div class="radio-row">
                        <label class="pill"><input type="radio" name="bleed" value="no" checked> ไม่มี</label>
                        <label class="pill"><input type="radio" name="bleed" value="yes"> มี</label>
                    </div>
                </div>
                <div class="col">
                    <label>โหมดแสดงผล</label>
                    <div class="radio-row">
                        <label class="pill"><input type="radio" name="displayMode" value="number" checked> แสดงเป็นตัวเลข</label>
                        <label class="pill"><input type="radio" name="displayMode" value="image"> แสดงเป็นรูปเม็ดยา</label>
                    </div>
                </div>
            </div>
        </form>
        <div id="results" class="result" style="display:none"></div>
    </section>
    <section id="tables" class="card" style="display:none">
        <h3 style="color:var(--accent)">ตารางแผนการให้ยา (7 วัน)</h3>
        <div id="plans"></div>
        <div style="margin-top:12px;text-align:right">
            <button onclick="window.print()" class="primary">ดาวน์โหลด / พิมพ์ (PDF)</button>
        </div>
    </section>
    
    <div class="standalone-calculator">
        <div class="calculator-header-new">เครื่องคิดคำนวณหาปริมาณ mg รวมใน 7 วัน ของ warfarin (รองรับ 2, 3, 5 mg)</div>
        
        <div class="dosing-comparison-container">
            
                        <div class="pill-dosing-container">
                <div id="dose2mgContainer" class="dose-input-group">
                    <div class="pill-section-title">Warfarin **2** mg (เม็ดสีส้ม)</div>
                    <div class="dose-input-row" data-mg="2">
                        <label>เม็ด:</label>
                        <input type="number" step="0.5" min="0" value="" class="pill-count" oninput="calculateComparison(false)">
                        <label>×</label>
                        <input type="number" step="1" min="0" max="7" value="" class="day-count" oninput="calculateComparison(false)">
                        <label>วัน</label>
                    </div>
                    <button class="add-row-btn" onclick="addRow(2)">+ เพิ่มวัน/ขนาดยา 2 mg</button>
                </div>
            </div>

                        <div class="pill-dosing-container">
                <div id="dose3mgContainer" class="dose-input-group">
                    <div class="pill-section-title">Warfarin **3** mg (เม็ดสีฟ้า)</div>
                    <div class="dose-input-row" data-mg="3">
                        <label>เม็ด:</label>
                        <input type="number" step="0.5" min="0" value="" class="pill-count" oninput="calculateComparison(false)">
                        <label>×</label>
                        <input type="number" step="1" min="0" max="7" value="" class="day-count" oninput="calculateComparison(false)">
                        <label>วัน</label>
                    </div>
                    <button class="add-row-btn" onclick="addRow(3)">+ เพิ่มวัน/ขนาดยา 3 mg</button>
                </div>
            </div>
            
            <div class="pill-dosing-container">
                <div id="dose5mgContainer" class="dose-input-group">
                    <div class="pill-section-title">Warfarin **5** mg (เม็ดสีชมพู)</div>
                    <div class="dose-input-row" data-mg="5">
                        <label>เม็ด:</label>
                        <input type="number" step="0.5" min="0" value="" class="pill-count" oninput="calculateComparison(false)">
                        <label>×</label>
                        <input type="number" step="1" min="0" max="7" value="" class="day-count" oninput="calculateComparison(false)">
                        <label>วัน</label>
                    </div>
                    <button class="add-row-btn" onclick="addRow(5)">+ เพิ่มวัน/ขนาดยา 5 mg</button>
                </div>
            </div>
            
            <div class="comparison-section">
                <h4>ข้อมูลเปรียบเทียบ/วันนัด</h4>
                <div class="dose-input-row" style="margin-bottom: 10px;">
                    <label for="initialWeeklyDose" style="width: 150px; color: var(--main-pink);">ขนาดยาเดิม (mg/สัปดาห์):</label>
                    <input type="number" step="0.1" id="initialWeeklyDose" min="0" style="width: 70px;" oninput="calculateComparison(false)">
                </div>
                <div class="dose-input-row">
                    <label for="dispenseDays" style="width: 150px; color: var(--main-pink);">วันนัดที่ต้องการจ่าย (วัน):</label>
                    <input type="number" id="dispenseDays" min="1" style="width: 70px;" oninput="calculateComparison(false)">
                </div>

                <div class="action-buttons">
                    <button class="clear-btn" onclick="clearData()">ล้าง</button>
                    <button class="calculate-btn" onclick="calculateComparison(true)">คำนวณ</button>
                </div>
            </div>

        </div> <div id="comparisonResult" class="comparison-output" style="display: none;">
            </div>
    </div>
    <footer class="card small">คำเตือน: เครื่องมือนี้เป็นเครื่องมือช่วยคำนวณเท่านั้น ไม่ใช่คำสั่งการรักษา เเพทย์/เภสัชกรเป็นผู้ตัดสินใจขั้นสุดท้าย</footer>
</div>
<script>
// --- START: COPY PROTECTION CODE (เดิม) ---
document.onkeydown = function(e) {
    if (e.keyCode == 123 || 
        (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) ||
        (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) ||
        (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) ) {
        return false;
    }
};
// --- END: COPY PROTECTION CODE (เดิม) ---

// ******************************************************
// ** GLOBAL FUNCTIONS (สำหรับเรียกจาก HTML: onclick/oninput) **
// ******************************************************

/**
 * ปัดเศษเป็นทศนิยม 2 ตำแหน่ง
 * @param {number} num
 */
function roundTwoDecimals(num) { 
    return Math.round(num * 100) / 100;
}

/**
 * เพิ่มแถวสำหรับการกรอกจำนวนเม็ดและวัน (Global)
 * @param {number} mg - 2, 3 หรือ 5
 */
function addRow(mg) {
    const containerId = `dose${mg}mgContainer`;
    const container = document.getElementById(containerId);
    
    if (!container) return; 

    const newRow = document.createElement('div');
    newRow.className = 'dose-input-row';
    newRow.setAttribute('data-mg', mg);
    newRow.innerHTML = `
        <label>เม็ด:</label>
        <input type="number" step="0.5" min="0" value="" class="pill-count" oninput="calculateComparison(false)">
        <label>×</label>
        <input type="number" step="1" min="0" max="7" value="" class="day-count" oninput="calculateComparison(false)">
        <label>วัน</label>
        <button onclick="removeRow(this)" style="background: none; border: none; color: #E91E63; cursor: pointer; font-weight: bold; font-size: 13px; padding: 0 5px;">[ลบ]</button>
    `;

    // เพิ่มแถวใหม่ก่อนปุ่มเพิ่มแถว (lastElementChild)
    container.insertBefore(newRow, container.lastElementChild);
    calculateComparison(false);
}

/**
 * ลบแถวที่ถูกเพิ่มมา (Global)
 * @param {HTMLElement} btn - ปุ่ม [ลบ] ที่ถูกกด
 */
function removeRow(btn) {
    const row = btn.parentNode;
    row.remove();
    calculateComparison(false);
}

/**
 * คำนวณขนาดยารวมต่อสัปดาห์และจำนวนเม็ดรวม (Global)
 * @param {boolean} isManualClick - true ถ้ามาจากการกดปุ่ม 'คำนวณ'
 */
function calculateComparison(isManualClick) {
    const initialDoseInput = document.getElementById('initialWeeklyDose');
    const daysInput = document.getElementById('dispenseDays');
    const resultDiv = document.getElementById('comparisonResult');

    if (!initialDoseInput || !daysInput || !resultDiv) return;

    // ใช้ค่า 0 และ 7 เป็นค่าเริ่มต้นหากช่องว่าง
    const initialWeeklyDose = parseFloat(initialDoseInput.value) || 0;
    const dispenseDays = parseInt(daysInput.value) || 7; 
    
    let totalWeeklyMg = 0;
    let total3mgPillsFor7Days = 0;
    let total2mgPillsFor7Days = 0;
    let total5mgPillsFor7Days = 0; // เพิ่มสำหรับ 5 mg

    const allDoseRows = document.querySelectorAll('.standalone-calculator .dose-input-row');
    
    allDoseRows.forEach(row => {
        const mg = parseInt(row.getAttribute('data-mg'));
        const pillCountInput = row.querySelector('.pill-count');
        const dayCountInput = row.querySelector('.day-count');
        
        if (!pillCountInput || !dayCountInput) return;
        
        // *** การแก้ไข: ใช้ parseFloat() || 0 เพื่อจัดการค่าว่าง/null/NaN จากช่อง input ว่าง ***
        const pillCount = parseFloat(pillCountInput.value) || 0;
        const dayCount = parseInt(dayCountInput.value) || 0;
        
        // ตรวจสอบความถูกต้องของวัน
        if (dayCount < 0 || dayCount > 7) {
            if (isManualClick) {
                 alert(`จำนวนวันสำหรับ Warfarin ${mg} mg ต้องอยู่ระหว่าง 0 ถึง 7`);
            }
            return; 
        }
        
        const weeklyMgFromRow = pillCount * mg * dayCount;
        totalWeeklyMg += weeklyMgFromRow;
        
        if (mg === 3) {
            total3mgPillsFor7Days += pillCount * dayCount;
        } else if (mg === 2) {
            total2mgPillsFor7Days += pillCount * dayCount;
        } else if (mg === 5) { // เพิ่มเงื่อนไขสำหรับ 5 mg
            total5mgPillsFor7Days += pillCount * dayCount;
        }
    });
    
    // ซ่อนผลลัพธ์หากไม่มีการใส่ค่าใดๆ ในช่อง Warfarin
    if (totalWeeklyMg === 0 && !isManualClick) {
         // ตรวจสอบว่าช่องป้อนค่าทั้งหมดว่างเปล่าหรือไม่
        const allEmpty = Array.from(allDoseRows).every(row => {
            const pillCountInput = row.querySelector('.pill-count');
            const dayCountInput = row.querySelector('.day-count');
            return (!pillCountInput.value || pillCountInput.value.trim() === '0') && 
                   (!dayCountInput.value || dayCountInput.value.trim() === '0');
        });
        
        if(allEmpty) {
            resultDiv.style.display = 'none';
            return;
        }
    }
    
    totalWeeklyMg = roundTwoDecimals(totalWeeklyMg);
    const dailyMg = roundTwoDecimals(totalWeeklyMg / 7);
    
    const diffMg = roundTwoDecimals(totalWeeklyMg - initialWeeklyDose);
    // คำนวณ % ความแตกต่าง
    const diffPct = initialWeeklyDose === 0 ? 
        (totalWeeklyMg === 0 ? 0 : 100) : // ถ้า dose เดิมเป็น 0 และ dose ใหม่ > 0 คือ +100% (แต่เราใช้ 0 ในกรณีนี้)
        roundTwoDecimals((diffMg / initialWeeklyDose) * 100);
    
    if(dispenseDays <= 0 && isManualClick) {
        alert('จำนวนวันนัดที่ต้องการจ่ายต้องเป็นจำนวนเต็มบวก');
    }

    // คำนวณจำนวนเม็ดที่ต้องจ่ายสำหรับวันนัด (ปัดขึ้น) (ใช้ dispenseDays = 7 ถ้าผู้ใช้ไม่ใส่ค่า)
    const final3mgPills = Math.ceil(total3mgPillsFor7Days * (dispenseDays / 7));
    const final2mgPills = Math.ceil(total2mgPillsFor7Days * (dispenseDays / 7));
    const final5mgPills = Math.ceil(total5mgPillsFor7Days * (dispenseDays / 7)); // คำนวณสำหรับ 5 mg

    let resultHTML = `
        <p>ขนาดยาใหม่ต่อสัปดาห์ (7 วัน): <strong>${totalWeeklyMg.toFixed(2)} mg</strong> (เฉลี่ย ${dailyMg.toFixed(2)} mg/วัน)</p>
        <p>ความแตกต่างจากขนาดยาเดิม (${initialWeeklyDose.toFixed(2)} mg): <strong style="color: ${diffMg >= 0 ? 'red' : 'green'};">${diffMg >= 0 ? '+' : ''}${diffMg.toFixed(2)} mg (${diffPct >= 0 ? '+' : ''}${diffPct.toFixed(2)}%)</strong></p>
        <hr style="border-top: 1px solid #ccc; margin: 10px 0;">
        <p>สรุปจำนวนเม็ดยาสำหรับ <strong>${dispenseDays} วันนัด</strong>:</p>
        <p>Warfarin 5 mg: <strong>${final5mgPills} เม็ด</strong></p>
        <p>Warfarin 3 mg: <strong>${final3mgPills} เม็ด</strong></p>
        <p>Warfarin 2 mg: <strong>${final2mgPills} เม็ด</strong></p>
    `;
    
    resultDiv.innerHTML = resultHTML;
    resultDiv.style.display = 'block';
}

/**
 * ล้างข้อมูลทั้งหมดในฟอร์มส่วนคำนวณคูณวัน (Global)
 */
function clearData() {
    const initialDoseInput = document.getElementById('initialWeeklyDose');
    const daysInput = document.getElementById('dispenseDays');
    const resultDiv = document.getElementById('comparisonResult');

    if (!initialDoseInput || !daysInput || !resultDiv) return;

    document.querySelectorAll('.standalone-calculator .dose-input-group').forEach(container => {
        // ลบแถวที่ถูกเพิ่ม (เริ่มจากแถวที่ 2 หรือ index 1)
        const rows = container.querySelectorAll('.dose-input-row');
        for (let i = 1; i < rows.length; i++) {
            rows[i].remove();
        }
        // เคลียร์แถวเริ่มต้น
        if (rows.length > 0) {
            const pillCountInput = rows[0].querySelector('.pill-count');
            const dayCountInput = rows[0].querySelector('.day-count');
            if (pillCountInput) pillCountInput.value = ''; // เคลียร์เป็นค่าว่าง
            if (dayCountInput) dayCountInput.value = '';  // เคลียร์เป็นค่าว่าง
        }
    });

    initialDoseInput.value = '';
    daysInput.value = '';
    resultDiv.style.display = 'none';
    resultDiv.innerHTML = '';
}


// ******************************************************
// ** DOM CONTENT LOADED (สำหรับ Event Listeners และ Funtions ภายใน) **
// ******************************************************

document.addEventListener('DOMContentLoaded', function() {
    
    // --- FUNTIONS เดิมที่ถูกเรียกใช้โดย Event Listeners (Local) ---
    function roundHalf(x){return Math.round(x*2)/2}
    function distributeEvenly7(total){
        const base = Math.floor(total/7);
        let arr = Array(7).fill(base);
        let rem = total - base*7;
        for(let i=0;i<rem;i++) arr[i]++;
        return arr;
    }
    
    /**
     * **ฟังก์ชันใหม่:** กระจายยา 7 วัน แบบเม็ดเต็ม (ห้ามแบ่งครึ่ง) และมีวันหยุดได้เพียง 1 วัน (0 mg)
     * @param {number} totalPills - จำนวนเม็ดเต็มรวม 7 วันที่ต้องการให้
     */
    function distributeEvenly7Fixed(totalPills) {
        if (totalPills === 0) return Array(7).fill(0);
        
        let daysToDose = 7;
        let arr = [];

        // เงื่อนไข: มีวันหยุดได้สูงสุด 1 วัน (ถ้าโดสต่ำกว่า 7 เม็ด)
        if (totalPills < 7) {
            daysToDose = 6; // จ่ายยาแค่ 6 วัน ที่เหลือเป็น 0 mg
        }
        
        const basePills = Math.floor(totalPills / daysToDose);
        arr = Array(daysToDose).fill(basePills);
        let remainingPills = totalPills - basePills * daysToDose;
        
        for (let i = 0; i < remainingPills; i++) arr[i]++;

        // ถ้าจ่ายแค่ 6 วัน ให้เพิ่ม 0 mg เข้าไป 1 วัน
        if (daysToDose === 6) {
            arr.push(0); 
        }

        // ต้องแน่ใจว่าค่าใน arr เป็น Integer (เม็ดเต็ม)
        return arr.map(p => Math.round(p)); 
    }
    
    function findBestCombo(target){
        // ตรรกะเดิม (ใช้ Warfarin 3mg และ 2mg)
        // เพื่อรองรับ 5mg ด้วย (ในอนาคต อาจต้องปรับตรรกะนี้หากต้องการให้คำนวณ 5mg ในส่วน INR)
        const numSets = Math.round(target / 5);
        const h3 = numSets;
        const h2 = numSets;
        const total = h3*3 + h2*2;
        return {h3:h3, h2:h2, total:total, type:'5mg'};
    }
    function generatePillImage(count, pillMg){
        let html = '';
        const fullPills = Math.floor(count);
        const hasHalf = count % 1 !== 0;
        let pillClass = '';
        if (pillMg === 3) pillClass = 'pill-icon-3mg';
        else if (pillMg === 2) pillClass = 'pill-icon-2mg';
        else if (pillMg === 5) pillClass = 'pill-icon-5mg'; // เพิ่ม 5 mg
        const pillText = `${pillMg} mg`;
        for(let i=0; i<fullPills; i++){
            html += `<div class="pill-icon-wrapper">
                        <span class="pill-icon ${pillClass}"></span>
                        <span class="tooltip-text">${pillText} (เต็มเม็ด)</span>
                    </div>`;
        }
        if(hasHalf){
            html += `<div class="pill-icon-wrapper">
                        <span class="pill-icon half-pill ${pillClass}"></span>
                        <span class="tooltip-text">${pillText} (ครึ่งเม็ด)</span>
                    </div>`;
        }
        return html; 
    }
    function buildPlanHTML(title, combo, weeklyDose, displayMode, total3PillCount, total2PillCount, planIndex){
        // **หมายเหตุ:** ส่วนนี้ใช้ตรรกะเดิมที่คำนวณจาก Warfarin 2mg/3mg เท่านั้น
        // หากต้องการให้ตรรกะ INR รองรับ 5mg ด้วย ต้องปรับปรุงส่วน findBestCombo และการกระจายยา 
        // แต่ในโค้ดนี้ ยังคงใช้ 3mg และ 2mg ในส่วนตารางแผนการให้ยา (Plan Table)
        const pillChoice = document.querySelector('input[name="pills"]:checked').value; 
        const isFixedDose = pillChoice === '3mg_fixed_1dayoff' || pillChoice === '2mg_fixed_1dayoff';

        let perDay3 = [];
        let perDay2 = [];

        // ใช้ฟังก์ชันกระจายยาตามประเภทเม็ด
        if (isFixedDose) {
            if (pillChoice === '3mg_fixed_1dayoff') {
                perDay3 = distributeEvenly7Fixed(combo.h3); // จำนวนเม็ด 3mg (เม็ดเต็ม)
                perDay2 = Array(7).fill(0);
            } else if (pillChoice === '2mg_fixed_1dayoff') {
                perDay2 = distributeEvenly7Fixed(combo.h2); // จำนวนเม็ด 2mg (เม็ดเต็ม)
                perDay3 = Array(7).fill(0);
            }
        } else {
            // ตรรกะเดิม (รองรับครึ่งเม็ด)
            perDay3 = distributeEvenly7(combo.h3);
            perDay2 = distributeEvenly7(combo.h2);
        }

        const totalWeekly = combo.total;
        const diffWeekPct = weeklyDose===0?0:((totalWeekly-weeklyDose)/weeklyDose)*100;
        const pctText = `${diffWeekPct>0?'+':''}${diffWeekPct.toFixed(2)}%`;
        const dayNames = ['จันทร์','อังคาร','พุธ','พฤหัส','ศุกร์','เสาร์','อาทิตย์'];
        const dayClasses = ['mon','tue','wed','thu','fri','sat','sun']; 
        
        let html = `<div class="plan-section plan-${planIndex}">`;
        html += `<h4>ตัวเลือก: ${title} — รวม ${totalWeekly.toFixed(2)} mg/สัปดาห์ (${pctText} จากเดิม)</h4>`;
        if (displayMode === 'image') {
            html += `<div class="plan-grid">`;
            for(let i=0;i<7;i++){
                let t3 = perDay3[i]; // เม็ด 3mg
                let t2 = perDay2[i]; // เม็ด 2mg

                if (!isFixedDose) {
                    if (combo.type === '3mg') { 
                        t3 = t3 / 2; // t3 เดิมเป็นจำนวนครึ่งเม็ด
                        t2 = 0;
                    } else if (combo.type === '2mg') { 
                        t2 = t2 / 2; // t2 เดิมเป็นจำนวนครึ่งเม็ด
                        t3 = 0;
                    }
                }
                
                const mg = t3*3 + t2*2;
                const t3Html = generatePillImage(t3, 3);
                const t2Html = generatePillImage(t2, 2);
                // ไม่มีการแสดง 5mg ในตารางนี้
                const totalPillUnits = Math.ceil(t3) + Math.ceil(t2);
                const shrinkClass = totalPillUnits >= 5 ? 'shrink-pills' : '';
                let doseText = '';
                if (t3 > 0) doseText += `3 mg x ${t3 % 1 === 0 ? t3 : t3.toFixed(1)}\n`;
                if (t2 > 0) doseText += `2 mg x ${t2 % 1 === 0 ? t2 : t2.toFixed(1)}`;
                html += `
                    <div class="day-card">
                        <div class="day-name ${dayClasses[i]}">${dayNames[i]}</div>
                        <div class="daily-mg">(${mg.toFixed(1)} mg)</div>
                        <div class="pill-container ${shrinkClass}">${t2Html}${t3Html}</div>
                        <div class="daily-dose-text" style="white-space:pre-line">${doseText.trim()}</div>
                    </div>
                `;
            }
            html += `</div>`;
            html += `<h4>รวมยาสำหรับ ${document.getElementById('days').value} วันนัด:</h4>`;
            html += `<div class="summary">`;
            if(total3PillCount > 0) {
                html += `<div class="summary-line"><span class="summary-pill pill-icon-3mg"></span> 3 mg: ${total3PillCount} เม็ด</div>`;
            }
            if(total2PillCount > 0) {
                html += `<div class="summary-line"><span class="summary-pill pill-icon-2mg"></span> 2 mg: ${total2PillCount} เม็ด</div>`;
            }
            html += `</div>`;
        } else {
            const pillTypes = [];
            // เพิ่มเงื่อนไขสำหรับตัวเลือกใหม่
            if (pillChoice === '3' || pillChoice === 'both' || pillChoice === '3mg_fixed_1dayoff') pillTypes.push({ label: '3 mg (เม็ด)', type: 3 });
            if (pillChoice === '2' || pillChoice === 'both' || pillChoice === '2mg_fixed_1dayoff') pillTypes.push({ label: '2 mg (เม็ด)', type: 2 });
            pillTypes.push({ label: 'รวม (mg)', type: 'total' });
            
            let headerCols = `<th>ชนิดยา</th>`;
            dayNames.forEach(day => { headerCols += `<th>${day}</th>`; });
            html += `<table class="plan-table plan-${planIndex}"><thead><tr>${headerCols}</tr></thead><tbody>`;
            
            pillTypes.forEach(pillType => {
                let dataRow = `<tr><td style="font-weight: 600;">${pillType.label}</td>`;
                for(let i=0;i<7;i++){
                    let t3 = perDay3[i];
                    let t2 = perDay2[i];
                    
                    if (!isFixedDose) {
                        if (combo.type === '3mg') { 
                            t3 = t3 / 2;
                            t2 = 0;
                        } else if (combo.type === '2mg') { 
                            t2 = t2 / 2;
                            t3 = 0;
                        }
                    }
                    
                    let displayValue = 0;
                    if(pillType.type === 3) displayValue = t3;
                    else if(pillType.type === 2) displayValue = t2;
                    else if(pillType.type === 'total') displayValue = t3*3 + t2*2;

                    dataRow += `<td>${displayValue === 0 ? '-' : displayValue.toFixed(pillType.type === 'total' ? 1 : (displayValue % 1 === 0 ? 0 : 1))}</td>`;
                }
                dataRow += `</tr>`;
                html += dataRow;
            });
            html += `</tbody></table>`;
        }
        html += `</div>`;
        return html;
    }

    function showResults() {
        const inr = parseFloat(document.getElementById('inr').value);
        const weeklyDose = parseFloat(document.getElementById('weeklyDose').value);
        const days = parseInt(document.getElementById('days').value);
        const pillChoice = document.querySelector('input[name="pills"]:checked').value;
        const bleed = document.querySelector('input[name="bleed"]:checked').value;
        const displayMode = document.querySelector('input[name="displayMode"]:checked').value;
        const resultsDiv = document.getElementById('results');
        const plansDiv = document.getElementById('plans');
        const tablesSection = document.getElementById('tables');

        if (isNaN(inr) || isNaN(weeklyDose) || isNaN(days) || days <= 0) {
            resultsDiv.style.display = 'none';
            tablesSection.style.display = 'none';
            return;
        }

        let targetWeeklyDose = 0;
        let note = '';

        if (inr < 1.5) {
            targetWeeklyDose = weeklyDose * 1.05; // เพิ่ม 5%
            note = "INR ต่ำเกินไป: อาจเพิ่มขนาดยาเล็กน้อย (+5%) และอาจมีวันพักยา (Hold Dose) 1 วันหากมีภาวะเลือดออก หรือหากแพทย์สั่ง";
        } else if (inr >= 1.5 && inr < 2.0) {
            targetWeeklyDose = weeklyDose * 1.10; // เพิ่ม 10%
            note = "INR ต่ำกว่าช่วงเป้าหมาย: เพิ่มขนาดยา (+10%)";
        } else if (inr >= 2.0 && inr <= 3.0) {
            targetWeeklyDose = weeklyDose * 1.00; // คงที่
            note = "INR อยู่ในช่วงเป้าหมาย (2.0-3.0): คงขนาดยาเท่าเดิม";
        } else if (inr > 3.0 && inr <= 4.0) {
            targetWeeklyDose = weeklyDose * 0.90; // ลด 10%
            note = "INR สูงกว่าช่วงเป้าหมายเล็กน้อย: ลดขนาดยา (-10%)";
            if (bleed === 'yes') {
                targetWeeklyDose = weeklyDose * 0.85; // ลด 15%
                note += "\n(มีภาวะเลือดออก: อาจลดเพิ่มเป็น -15% และงด 1 Dose)";
            }
        } else if (inr > 4.0 && inr <= 5.0) {
            targetWeeklyDose = weeklyDose * 0.80; // ลด 20%
            note = "INR สูงเกินไป: งด 1 วัน แล้วลดขนาดยา (-20%)";
            if (bleed === 'yes') {
                targetWeeklyDose = weeklyDose * 0.75; // ลด 25%
                note += "\n(มีภาวะเลือดออก: อาจลดเพิ่มเป็น -25% และงด 1-2 Dose)";
            }
        } else if (inr > 5.0) {
            targetWeeklyDose = weeklyDose * 0.70; // ลด 30%
            note = "INR สูงอันตราย: งด 2-3 วัน แล้วลดขนาดยา (-30%) และพิจารณาให้ Vitamin K";
            if (bleed === 'yes') {
                targetWeeklyDose = weeklyDose * 0.60; // ลด 40%
                note += "\n(มีภาวะเลือดออก: อาจลดเพิ่มเป็น -40% และงด 3+ Dose พร้อม Vitamin K)";
            }
        }

        targetWeeklyDose = roundTwoDecimals(targetWeeklyDose);
        const diff = roundTwoDecimals(targetWeeklyDose - weeklyDose);
        const diffPct = weeklyDose === 0 ? 0 : roundTwoDecimals((diff / weeklyDose) * 100);

        let resultHTML = `
            <h3>ผลการคำนวณเบื้องต้น</h3>
            <table>
                <tr>
                    <th>ขนาดยาเดิม/สัปดาห์</th>
                    <th>ขนาดยาใหม่ที่แนะนำ/สัปดาห์</th>
                    <th>ความแตกต่าง</th>
                </tr>
                <tr>
                    <td>${weeklyDose.toFixed(1)} mg</td>
                    <td style="font-weight:bold">${targetWeeklyDose.toFixed(1)} mg</td>
                    <td style="color:${diff >= 0 ? 'red' : 'green'}; font-weight:bold">${diff >= 0 ? '+' : ''}${diff.toFixed(1)} mg (${diffPct >= 0 ? '+' : ''}${diffPct.toFixed(1)}%)</td>
                </tr>
            </table>
            <div class="note"><strong>ข้อแนะนำ:</strong> ${note}</div>
        `;
        resultsDiv.innerHTML = resultHTML;
        resultsDiv.style.display = 'block';

        // --- การคำนวณแผนการจ่ายยา 7 วัน ---
        const targetDailyDose = targetWeeklyDose / 7;
        let plansHTML = '';
        let targetPillValue = 0;
        
        // ตรวจสอบความถูกต้องของขนาดยาที่ใช้ในตาราง
        // (ส่วนนี้ยังจำกัดอยู่แค่ 2 mg และ 3 mg ตามตรรกะเดิมของตาราง)
        const isOnly3mg = pillChoice === '3' || pillChoice === '3mg_fixed_1dayoff';
        const isOnly2mg = pillChoice === '2' || pillChoice === '2mg_fixed_1dayoff';

        // 1. แผนที่ใช้การคำนวณเม็ดจาก Dose ใหม่ (Default)
        if (isOnly3mg) {
            targetPillValue = roundHalf(targetWeeklyDose / 3); // 3 mg/เม็ด
            let combo = { h3: targetPillValue * 2, h2: 0, total: targetPillValue * 3, type: '3mg' };
            if (pillChoice === '3mg_fixed_1dayoff') combo.h3 = Math.round(targetPillValue); // เม็ดเต็ม
            const totalPills = Math.ceil(combo.h3 * (pillChoice === '3mg_fixed_1dayoff' ? 1 : 0.5) * (days / 7));
            plansHTML += buildPlanHTML("ใช้เม็ด 3 mg เท่านั้น", combo, weeklyDose, displayMode, totalPills, 0, 1);
        } else if (isOnly2mg) {
            targetPillValue = roundHalf(targetWeeklyDose / 2); // 2 mg/เม็ด
            let combo = { h3: 0, h2: targetPillValue * 2, total: targetPillValue * 2, type: '2mg' };
            if (pillChoice === '2mg_fixed_1dayoff') combo.h2 = Math.round(targetPillValue); // เม็ดเต็ม
            const totalPills = Math.ceil(combo.h2 * (pillChoice === '2mg_fixed_1dayoff' ? 1 : 0.5) * (days / 7));
            plansHTML += buildPlanHTML("ใช้เม็ด 2 mg เท่านั้น", combo, weeklyDose, displayMode, 0, totalPills, 1);
        } else {
            // ใช้ทั้ง 2 และ 3 mg
            let combo1 = findBestCombo(targetWeeklyDose);
            const total3PillCount1 = Math.ceil(combo1.h3 * (days / 7));
            const total2PillCount1 = Math.ceil(combo1.h2 * (days / 7));
            plansHTML += buildPlanHTML("ตัวเลือกการจ่ายยา 2 & 3 mg", combo1, weeklyDose, displayMode, total3PillCount1, total2PillCount1, 1);

            // 2. ทางเลือกที่ 2 (ตัวเลือกความแม่นยำต่ำกว่า)
            let totalPillsHalf = roundHalf(targetWeeklyDose / 2); // จำนวนครึ่งเม็ด 2mg (สมมุติ)
            let combo2 = { h3: 0, h2: totalPillsHalf * 2, total: totalPillsHalf * 2, type: '2mg' };
            const total2PillCount2 = Math.ceil(totalPillsHalf * (days / 7));
            plansHTML += buildPlanHTML("ทางเลือก: ใช้เม็ด 2 mg (อาจมีครึ่งเม็ด)", combo2, weeklyDose, displayMode, 0, total2PillCount2, 2);

            // 3. ทางเลือกที่ 3 (ตัวเลือกความแม่นยำต่ำกว่า)
            let totalPillsThird = roundHalf(targetWeeklyDose / 3); // จำนวนครึ่งเม็ด 3mg (สมมุติ)
            let combo3 = { h3: totalPillsThird * 2, h2: 0, total: totalPillsThird * 3, type: '3mg' };
            const total3PillCount3 = Math.ceil(totalPillsThird * (days / 7));
            plansHTML += buildPlanHTML("ทางเลือก: ใช้เม็ด 3 mg (อาจมีครึ่งเม็ด)", combo3, weeklyDose, displayMode, total3PillCount3, 0, 3);
        }

        plansDiv.innerHTML = plansHTML;
        tablesSection.style.display = 'block';

        // ซิงค์ค่า Weekly Dose/Days ไปที่ Calculator ด้านล่าง (เพื่อความสะดวก)
        document.getElementById('initialWeeklyDose').value = targetWeeklyDose.toFixed(1);
        document.getElementById('dispenseDays').value = days;
        calculateComparison(false); // เรียกคำนวณแบบไม่ต้องแสดง alert
    }

    // --- Event Listeners เดิม (เรียกใช้ showResults) ---
    document.getElementById('form').addEventListener('input', showResults);
    
    // เริ่มต้นแสดงผลหากมีค่าเริ่มต้น
    showResults();
});
</script>
</body>
</html>
